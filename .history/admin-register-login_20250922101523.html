<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
  <title>Yönetici Kayıt / Giriş</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg:#f2f2f2; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --primary:#191919; --primary-contrast:#ffffff;
      --radius:14px; --shadow:0 4px 20px rgba(0,0,0,0.08);
      --input:#f9fafb; --input-border:#e5e7eb;
      --divider:#e5e7eb; --pill:#f3f4f6; --danger:#ef4444;
      --ok-bg:#ecfdf5; --ok-bd:#a7f3d0; --ok-fg:#065f46;
      --focus:#111827;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0b0b; --card:#121212; --text:#f3f4f6; --muted:#9ca3af;
        --primary:#e5e7eb; --primary-contrast:#111827;
        --input:#0f0f0f; --input-border:#1f2937; --divider:#1f2937; --pill:#111214;
        --ok-bg:#0b2e26; --ok-bd:#084939; --ok-fg:#a7f3d0;
        --focus:#e5e7eb;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text); background:var(--bg);
      display:flex; align-items:center; justify-content:center;
      padding:clamp(16px, 3.5vw, 32px);
      padding-top:calc(env(safe-area-inset-top,0) + clamp(16px,3.5vw,32px));
      padding-bottom:calc(env(safe-area-inset-bottom,0) + clamp(16px,3.5vw,32px));
    }
    .card{
      width:100%; max-width:560px; background:var(--card);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:28px 22px 22px; position:relative;
    }

    .cont-banner{
      display:none; align-items:center; gap:10px; border:1px dashed var(--input-border);
      background:color-mix(in oklab, var(--input) 80%, transparent);
      padding:10px 12px; border-radius:12px; margin:-6px 0 12px;
    }
    .cont-banner.show{ display:flex; }
    .cont-banner .meta{ font-size:13px; color:var(--muted); }
    .cont-banner .btn-mini{
      margin-left:auto; border:1px solid var(--input-border); background:var(--card); color:inherit;
      height:32px; padding:0 12px; border-radius:8px; font-weight:700; cursor:pointer;
    }

    .tabs{ display:inline-flex; background:var(--pill); border-radius:999px; padding:4px; gap:4px; margin:0 auto 18px; }
    .tabs button{
      border:none; background:transparent; padding:10px 18px; border-radius:999px;
      font-weight:700; color:var(--muted); cursor:pointer;
    }
    .tabs button.active{ background:var(--card); color:var(--text); box-shadow:0 1px 2px rgba(0,0,0,0.08);}
    .title{ text-align:center; font-size:22px; font-weight:800; margin:6px 0 18px; letter-spacing:.2px; }
    .form-row{ margin-bottom:14px; }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; font-weight:600; }
    input[type="email"],input[type="password"]{
      width:100%; height:46px; border-radius:10px; border:1px solid var(--input-border);
      background:var(--input); padding:0 14px; font-size:15px; outline:none; color:var(--text);
    }
    input:focus{ outline:2px solid transparent; box-shadow:0 0 0 3px color-mix(in oklab, var(--focus) 25%, transparent); }
    input[aria-invalid="true"]{ border-color:var(--danger); }
    .error-text,.warn-text{ font-size:12px; margin-top:6px; display:none; }
    .error-text.show{ display:block; color:var(--danger); }
    .warn-text.show{ display:block; color:var(--danger); }

    .btn{
      width:100%; min-height:46px; border-radius:10px; border:1px solid transparent;
      font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;
      transition:transform .04s ease, opacity .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform:scale(.995); }
    .btn[disabled]{ opacity:.6; cursor:progress; }
    .btn-primary{ background:var(--primary); color:var(--primary-contrast); }
    .btn-ghost{ background:var(--card); border-color:var(--input-border); color:var(--text); }
    .btn i{ font-size:18px; }
    .btn-google i{ font-size:20px; color:#4285F4; }

    .or{ display:flex; align-items:center; gap:12px; color:var(--muted); font-size:12px; margin:18px 0; }
    .or::before, .or::after{ content:""; flex:1; height:1px; background:var(--divider); }

    .pane{ display:none; } .pane.active{ display:block; }
    @media (max-width:560px){ .card{ padding:22px 16px; } }

    .pw-wrap{ position:relative; }
    .pw-toggle{
      position:absolute; inset:auto 8px 0 auto; height:46px; display:inline-flex; align-items:center; justify-content:center;
      border:none; background:transparent; color:var(--muted); cursor:pointer; padding:0 8px;
    }

    .ok-banner,.info-banner{
      display:none; align-items:flex-start; gap:10px;
      margin:-6px 0 12px; padding:10px 12px;
      border-radius:10px; font-size:13px;
    }
    .ok-banner{ border:1px solid var(--ok-bd); background:var(--ok-bg); color:var(--ok-fg); }
    .info-banner{ border:1px solid #c7d2fe; background:#eef2ff; color:#3730a3; }
    @media (prefers-color-scheme: dark){
      .info-banner{ border-color:#4048a8; background:#1a1f4a; color:#c7d2fe; }
    }
    .ok-banner.show,.info-banner.show{ display:flex; }

    .footnote{ margin:8px 0 0; }
    a{ color:inherit; }
    a.under{ text-decoration:underline; font-weight:700; }
  </style>
</head>
<body>
  <main class="card" role="main" aria-live="polite">
    <div id="continueBanner" class="cont-banner" role="status" aria-live="polite">
      <i class="fa-solid fa-forward"></i>
      <div>
        <div><strong>Kayıta kaldığınız yerden devam edin</strong></div>
        <div class="meta" id="continueMeta">Son adım: –</div>
      </div>
      <button id="btnContinueFlow" class="btn-mini" type="button">Devam et</button>
    </div>

    <div id="okBanner" class="ok-banner" role="status" aria-live="polite">
      <i class="fa-solid fa-circle-check" style="margin-top:2px"></i>
      <div><strong>Kayıt tamamlandı.</strong> Şimdi giriş yapabilirsiniz.</div>
      <button id="okDismiss" class="btn-ghost" style="height:30px;padding:0 10px;border-radius:8px;margin-left:auto;">Kapat</button>
    </div>

    <div id="infoBanner" class="info-banner" role="status" aria-live="polite">
      <i class="fa-solid fa-circle-info" style="margin-top:2px"></i>
      <div><strong>Bu e-posta zaten kayıtlı.</strong> Giriş yapabilirsiniz.</div>
      <button id="infoDismiss" class="btn-ghost" style="height:30px;padding:0 10px;border-radius:8px;margin-left:auto;">Kapat</button>
    </div>

    <div class="tabs" role="tablist" aria-label="Kimlik doğrulama sekmeleri">
      <button id="tab-login"  type="button" role="tab" aria-controls="pane-login">Giriş</button>
      <button id="tab-signup" type="button" role="tab" aria-controls="pane-signup" class="active">Kayıt ol</button>
    </div>

    <!-- KAYIT -->
    <section id="pane-signup" class="pane active" role="tabpanel" aria-labelledby="tab-signup">
      <h2 class="title">Hesap oluştur</h2>
      <div class="form-row">
        <label for="signup-email">E-posta adresi</label>
        <input id="signup-email" type="email" inputmode="email" placeholder="ornek@eposta.com" autocomplete="email" />
        <div id="warn-signup-exists" class="warn-text">Bu e-posta zaten kayıtlı.</div>
      </div>
      <button id="btn-signup-email" type="button" class="btn btn-primary">
        <i class="fa-regular fa-envelope"></i> E-posta ile devam et
      </button>
    </section>

    <!-- GİRİŞ -->
    <section id="pane-login" class="pane" role="tabpanel" aria-labelledby="tab-login">
      <h2 class="title">Tekrar hoş geldiniz</h2>
      <div class="form-row">
        <label for="login-email">E-posta adresi</label>
        <input id="login-email" type="email" inputmode="email" placeholder="ornek@eposta.com" autocomplete="email" />
        <div id="err-email" class="error-text">Lütfen e-posta adresinizi girin.</div>
      </div>
      <div class="form-row">
        <label for="login-pass">Şifre</label>
        <div class="pw-wrap">
          <input id="login-pass" type="password" placeholder="••••••••" autocomplete="current-password" />
          <button type="button" id="pwToggle" class="pw-toggle" aria-label="Şifreyi göster/gizle"><i class="fa-regular fa-eye"></i></button>
        </div>
        <div id="err-pass" class="error-text">Lütfen şifrenizi girin.</div>
      </div>
      <button id="btn-login" type="button" class="btn btn-primary">
        <i class="fa-regular fa-envelope"></i> E-posta ile giriş yap
      </button>
      <div style="text-align:center; margin-top:10px;">
        <a href="#" id="link-forgot" class="under">Şifremi unuttum?</a>
      </div>
      <div class="or">veya</div>
      <button id="btn-google-login" type="button" class="btn btn-ghost btn-google">
        <i class="fa-brands fa-google"></i> Google ile giriş yap
      </button>
    </section>

    <p class="footnote" id="footnote-switch" style="text-align:center; color:var(--muted); font-size:12px;">
      Zaten hesabın var mı? <a href="#" id="link-switch" class="under">Giriş yap</a>
    </p>
  </main>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import {
    fetchSignInMethodsForEmail, signInWithEmailAndPassword,
    sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup,
    signOut, setPersistence, browserLocalPersistence, onAuthStateChanged, getIdTokenResult
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    doc, getDoc, collection, query, where, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const $=(s,r=document)=>r.querySelector(s);
  const emailOk=v=>/^\S+@\S+\.\S+$/.test((v||"").trim());

  // localStorage keys
  const K_METHOD="admin_onboarding_method";
  const K_FLOW="admin_onboarding_flow";
  const K_EMAIL="pending_admin_email";
  const K_RETURN="return_to";
  const K_REGOK="__reg_ok";
  const K_LAST="admin_onboarding_last_step";

  const K_FAILS="auth_fail_count";
  const K_BLOCK_UNTIL="auth_block_until";

  (function seedReturnToFromQuery(){
    try{
      const q=new URLSearchParams(location.search);
      const rt=q.get("return_to");
      if(rt){
        const u=new URL(rt, location.origin);
        if(u.origin===location.origin){
          localStorage.setItem(K_RETURN, u.pathname + u.search + u.hash);
        }
      }
    }catch{}
  })();

  const ERRMAP = {
    "auth/invalid-credential": "E-posta veya şifre hatalı.",
    "auth/invalid-email": "Geçerli bir e-posta adresi girin.",
    "auth/missing-password": "Lütfen şifrenizi girin.",
    "auth/user-disabled": "Hesabınız devre dışı.",
    "auth/user-not-found": "Bu e-posta ile kullanıcı bulunamadı.",
    "auth/wrong-password": "E-posta veya şifre hatalı.",
    "auth/too-many-requests": "Çok sayıda başarısız deneme. Lütfen biraz sonra tekrar deneyin.",
    "auth/network-request-failed": "Ağ hatası. İnternet bağlantınızı kontrol edin.",
    "auth/operation-not-allowed": "Bu giriş yöntemi devre dışı.",
    "auth/popup-blocked": "Açılır pencere engellendi.",
    "auth/popup-closed-by-user": "İşlem iptal edildi.",
    "auth/cancelled-popup-request": "Başka bir giriş penceresi açık.",
    "auth/weak-password": "Şifre çok zayıf.",
    "auth/email-already-in-use": "Bu e-posta zaten kayıtlı.",
    "auth/quota-exceeded": "Kota aşıldı.",
    "auth/internal-error": "Sunucu hatası."
  };
  function friendly(err, fallback = "İşlem yapılamadı. Lütfen tekrar deneyin.") {
    const code = (err && err.code) ? String(err.code) : "";
    const msg = ERRMAP[code];
    if (!msg) console.warn("[auth-error]", code || err, err?.message);
    return msg || fallback;
  }
  function safeRedirect(url){
    try{
      const u=new URL(url, location.origin);
      if (u.origin === location.origin) location.replace(u.href);
    }catch{}
  }
  function setLoading(btn, on=true){
    if(!btn) return;
    btn.disabled = !!on;
    btn.dataset.loading = on ? "1" : "";
    if(on){
      btn.dataset._label = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> İşleniyor…';
    }else if(btn.dataset._label){
      btn.innerHTML = btn.dataset._label;
      delete btn.dataset._label;
    }
  }

  const errE=$("#err-email"), errP=$("#err-pass");
  function showErr(el,box,msg){ box.textContent=msg; el.setAttribute("aria-invalid","true"); box.classList.add("show"); }
  function clearErr(){ errE.classList.remove("show"); errP.classList.remove("show"); $("#login-email").removeAttribute("aria-invalid"); $("#login-pass").removeAttribute("aria-invalid"); }

  const warnSignupExists=$("#warn-signup-exists");
  function clearSignupWarnings(){ warnSignupExists.classList.remove("show"); $("#signup-email").removeAttribute("aria-invalid"); }
  $("#signup-email")?.addEventListener("input", clearSignupWarnings);

  const okBanner=$("#okBanner"), okDismiss=$("#okDismiss");
  okDismiss?.addEventListener("click",()=>okBanner.classList.remove("show"));
  const infoBanner=$("#infoBanner"), infoDismiss=$("#infoDismiss");
  function showInfo(msg){
    if(msg) infoBanner.querySelector("div").innerHTML = "<strong>Uyarı:</strong> " + msg;
    infoBanner.classList.add("show");
  }
  infoDismiss?.addEventListener("click",()=>infoBanner.classList.remove("show"));

  const cont=$("#continueBanner"), contMeta=$("#continueMeta"), contBtn=$("#btnContinueFlow");
  function stepUrl(n){
    const num = parseInt(n,10);
    if(isNaN(num) || num<1) return "admin-register1.html";
    if(num>=9) return "admin-register9.html";
    return `admin-register${num}.html`;
  }
  (function mountContinueBanner(){
    const last = (localStorage.getItem(K_LAST)||"").trim();
    const flow = (localStorage.getItem(K_FLOW)||"").trim().toLowerCase();
    if(flow==="admin" && last){
      contMeta.textContent = "Son adım: " + last;
      cont.classList.add("show");
      contBtn.addEventListener("click", ()=>{
        const target = stepUrl(last);
        location.replace(target);
      });
    }
  })();

  const loginTab=$("#tab-login"), signupTab=$("#tab-signup"),
        loginPane=$("#pane-login"), signupPane=$("#pane-signup"), foot=$("#footnote-switch");
  function attachSwitchLink(isLogin){
    const a=$("#link-switch");
    a?.addEventListener("click",e=>{
      e.preventDefault(); activate(isLogin?"signup":"login");
    });
  }
  function activate(which){
    const isLogin=which==="login";
    loginTab.classList.toggle("active",isLogin);
    signupTab.classList.toggle("active",!isLogin);
    loginPane.classList.toggle("active",isLogin);
    signupPane.classList.toggle("active",!isLogin);
    foot.innerHTML=isLogin
      ? 'Hesabın yok mu? <a href="#" id="link-switch" class="under">Kayıt ol</a>'
      : 'Zaten hesabın var mı? <a href="#" id="link-switch" class="under">Giriş yap</a>';
    attachSwitchLink(isLogin);
    clearSignupWarnings(); clearErr();
    if(isLogin) $("#login-email")?.focus(); else $("#signup-email")?.focus();
  }
  loginTab?.addEventListener("click",()=>activate("login"));
  signupTab?.addEventListener("click",()=>activate("signup"));
  function initFromHash(){ (location.hash||"").toLowerCase()==="#login"?activate("login"):activate("signup"); }
  window.addEventListener("hashchange",initFromHash);

  setPersistence(auth, browserLocalPersistence).catch(()=>{});

  // --- BUSINESSES tabanlı yardımcılar ---
  async function findBusinessByOwnerId(uid){
    try{
      const q = query(collection(db, "businesses"),
        where("owner.ownerId","==", uid), limit(1));
      const snap = await getDocs(q);
      if (snap.empty) return null;
      const d = snap.docs[0];
      return { id: d.id, ...d.data() };
    }catch{ return null; }
  }

  async function findBusinessByEmail(emailLower){
    try{
      // 1) businesses.email
      let q = query(collection(db,"businesses"),
        where("email","==", emailLower), limit(1));
      let snap = await getDocs(q);
      if (!snap.empty){ const d=snap.docs[0]; return { id: d.id, ...d.data() }; }

      // 2) businesses.owner.email
      q = query(collection(db,"businesses"),
        where("owner.email","==", emailLower), limit(1));
      snap = await getDocs(q);
      if (!snap.empty){ const d=snap.docs[0]; return { id: d.id, ...d.data() }; }
    }catch{}
    return null;
  }

  // Admin tespiti: custom claim varsa, yoksa businesses üzerinden
  async function isAdmin(uid){
    try{
      const tok = await getIdTokenResult(auth.currentUser, true);
      if(tok?.claims?.admin === true) return true;
    }catch{}

    const biz = await findBusinessByOwnerId(uid);
    if(!biz) return false;

    if (biz.onboardingCompleted === true) return true;
    if (biz?.progress?.current >= 1) return true; // akışa başlamışsa yine kabul
    return false;
  }

  // E-posta → rol ipucu (BUSINESSES üstünden)
  async function getRoleHintByEmail(emailLower){
    const biz = await findBusinessByEmail(emailLower);
    return biz ? "admin" : null;
  }

  onAuthStateChanged(auth, async (u)=>{
    if(!u) return;
    try{
      if(await isAdmin(u.uid)){
        const rt=localStorage.getItem(K_RETURN);
        if(rt){ localStorage.removeItem(K_RETURN); safeRedirect(rt); return; }
        // işletmeyi önbelleğe al
        const biz = await findBusinessByOwnerId(u.uid);
        if(biz){
          localStorage.setItem("business_id", biz.id);
          localStorage.setItem("business_name", biz.name || biz.owner?.name || "");
        }
        location.replace("calendar.html");
      }
    }catch{}
  });

  async function finishLogin(cred){
    const rt=localStorage.getItem(K_RETURN);
    if(rt){ localStorage.removeItem(K_RETURN); safeRedirect(rt); return; }
    if(await isAdmin(cred.user.uid)){
      const biz = await findBusinessByOwnerId(cred.user.uid);
      if(biz){
        localStorage.setItem("business_id", biz.id);
        localStorage.setItem("business_name", biz.name || biz.owner?.name || "");
      }
      location.replace("calendar.html");
    } else {
      await signOut(auth);
      alert("Bu e-posta ile admin/işletme sahibi bulunamadı.");
      activate("signup");
    }
  }

  // --- Sign-in method kontrolü + fallback ---
  async function getSignInMethods(email){
    try{
      const sdk = await fetchSignInMethodsForEmail(auth, email);
      if (sdk && sdk.length >= 0) return sdk;
    }catch(e){}
    try{
      const res = await fetch(
        `https://identitytoolkit.googleapis.com/v1/accounts:createAuthUri?key=${auth.app.options.apiKey}`,
        {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ identifier: email, continueUri: location.origin })
        }
      );
      if (!res.ok) return [];
      const d = await res.json();
      if(d?.registered) return ["password"];
      return d?.signinMethods || [];
    }catch(e){
      return [];
    }
  }
  // ------------------------------------

  // SIGNUP (admin akışını başlatma veya bloklama)
  $("#btn-signup-email")?.addEventListener("click", async ()=>{
    clearSignupWarnings();
    const input=$("#signup-email");
    const email = (input.value||"").trim().toLowerCase();
    if(!emailOk(email)){
      input.focus();
      input.setAttribute("aria-invalid","true");
      return;
    }
    const btn=$("#btn-signup-email"); setLoading(btn, true);

    try{
      const methods = await getSignInMethods(email);

      if(methods.length === 0){
        // Yeni kayıt akışına gir
        localStorage.setItem(K_METHOD, "password");
        localStorage.setItem(K_EMAIL, email);
        localStorage.setItem(K_FLOW, "admin");
        localStorage.setItem(K_LAST, "1");
        location.replace("admin-register1.html");
        return;
      }

      // E-posta zaten kayıtlı
      const roleHint = await getRoleHintByEmail(email);
      if(roleHint === "admin"){
        showInfo("Bu e-posta admin olarak zaten kayıtlı. Giriş yapabilirsiniz.");
      } else {
        showInfo("Bu e-posta başka bir kullanıcı için kayıtlı. Lütfen farklı bir e-posta deneyin.");
      }
      input.setAttribute("aria-invalid","true");
      warnSignupExists.classList.add("show");

    } catch(e) {
      alert(friendly(e, "E-posta kontrolü şu anda yapılamıyor."));
    } finally {
      setLoading(btn, false);
    }
  });

  // LOGIN + throttle
  function isBlocked(){
    const until = parseInt(localStorage.getItem(K_BLOCK_UNTIL)||"0",10);
    return Date.now() < until;
  }
  function registerFail(){
    const c = parseInt(localStorage.getItem(K_FAILS)||"0",10)+1;
    if(c >= 5){
      localStorage.setItem(K_BLOCK_UNTIL, String(Date.now()+30_000));
      localStorage.setItem(K_FAILS, "0");
    } else {
      localStorage.setItem(K_FAILS, String(c));
    }
  }
  function resetFails(){
    localStorage.removeItem(K_FAILS);
    localStorage.removeItem(K_BLOCK_UNTIL);
  }

  $("#btn-login")?.addEventListener("click", async ()=>{
    clearErr();
    const emailEl=$("#login-email"), passEl=$("#login-pass");
    const email=(emailEl.value||"").trim().toLowerCase();
    const pass=(passEl.value||"").trim();

    if(isBlocked()){
      showErr(passEl, errP, "Çok fazla deneme yapıldı. Lütfen 30 saniye sonra tekrar deneyin.");
      return;
    }

    if(!email||!pass){
      if(!email)showErr(emailEl,errE,"E-posta girin.");
      if(!pass)showErr(passEl,errP,"Şifre girin.");
      return;
    }
    setLoading($("#btn-login"), true);
    try{
      const cred=await signInWithEmailAndPassword(auth,email,pass);
      resetFails();
      await finishLogin(cred);
    }catch(e){
      if (["auth/invalid-credential","auth/wrong-password","auth/user-not-found"].includes(e.code)) {
        registerFail();
      }
      showErr($("#login-pass"), errP, friendly(e, "Giriş yapılamadı."));
    }finally{
      setLoading($("#btn-login"), false);
    }
  });
  $("#login-pass")?.addEventListener("keydown",e=>{ if(e.key==="Enter") $("#btn-login").click(); });
  $("#login-email")?.addEventListener("keydown",e=>{ if(e.key==="Enter") $("#btn-login").click(); });

  $("#pwToggle")?.addEventListener("click", ()=>{
    const inp=$("#login-pass");
    const show = inp.type === "password";
    inp.type = show ? "text" : "password";
    $("#pwToggle i").className = show ? "fa-regular fa-eye-slash" : "fa-regular fa-eye";
  });

  const provider=new GoogleAuthProvider(); provider.setCustomParameters({prompt:"select_account"});
  $("#btn-google-login")?.addEventListener("click", async ()=>{
    setLoading($("#btn-google-login"), true);
    try{
      const cred=await signInWithPopup(auth,provider);
      resetFails();
      await finishLogin(cred);
    }catch(e){
      if(e.code!=="auth/popup-closed-by-user") alert(friendly(e, "Google ile giriş yapılamadı."));
    }finally{
      setLoading($("#btn-google-login"), false);
    }
  });

  $("#link-forgot")?.addEventListener("click", async e=>{
    e.preventDefault();
    const email=($("#login-email").value||"").trim().toLowerCase();
    if(!emailOk(email)){ showErr($("#login-email"),errE,"Önce e-posta girin."); return; }
    try{ await sendPasswordResetEmail(auth,email); alert("Şifre sıfırlama e-postası gönderildi."); }
    catch(e2){ alert(friendly(e2, "Şifre sıfırlama e-postası gönderilemedi.")); }
  });

  function showRegistrationOk(){
    if(localStorage.getItem(K_REGOK)==="1"){
      $("#okBanner").classList.add("show");
      const email=localStorage.getItem(K_EMAIL)||"";
      if(email){
        $("#login-email").value=email;
        activate("login");
      }
      localStorage.removeItem(K_REGOK);
    }
  }

  (function prefillFromPending(){
    const em=(localStorage.getItem(K_EMAIL)||"").trim().toLowerCase();
    if(!em) return;
    const s=$("#signup-email"), l=$("#login-email");
    if(s && !s.value) s.value = em;
    if(l && !l.value) l.value = em;
  })();

  initFromHash(); showRegistrationOk();
</script>
<script src="https://www.google.com/recaptcha/api.js?render=6LeOxMgrAAAAANHG5q2IiflzNs-VCHBjzRIvSmPN" async defer></script>
</body>
</html>
