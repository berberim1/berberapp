<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Daha Fazla Personel Ekle</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#eef2f5; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
      --primary:#111111; --accent:#00c48c; --radius:16px; --shadow:0 18px 50px rgba(15,23,42,.12);
      --ok:#0f766e; --input:#f9fafb; --ring:rgba(37,99,235,.18);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0c0f; --card:#0f1115; --text:#e5e7eb; --muted:#9ba3af; --border:#1f2937;
        --primary:#e5e7eb; --accent:#00c48c; --shadow:0 24px 80px rgba(0,0,0,.6);
        --input:#0c0e12; --ring:rgba(96,165,250,.25);
      }
    }
    *{ box-sizing:border-box }
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text);
      display:flex;align-items:center;justify-content:center;
      padding:24px 16px calc(env(safe-area-inset-bottom,0) + 24px);
      padding-top:calc(env(safe-area-inset-top,0) + 12px);
    }
    .container{
      width:min(720px,100%);background:var(--card);border-radius:22px;box-shadow:var(--shadow);overflow:hidden;
    }
    .top{display:flex;align-items:center;gap:12px;padding:16px 18px 10px;border-bottom:1px solid var(--border);}
    .back-btn{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:var(--card);cursor:pointer;color:inherit;}
    .progress-outer{flex:1;height:8px;border-radius:999px;background:#f2f4f7;overflow:hidden;}
    .progress-inner{height:100%;width:88%;background:var(--accent);}
    @media (prefers-color-scheme: dark){ .progress-outer{background:#151a21;} }

    .header{text-align:center;padding:12px 26px;}
    .header h1{margin:0;font-size:24px;font-weight:800;}
    .header p{margin:6px 0 0;color:var(--muted);}

    .section{padding:18px 22px;}
    .staff-list{display:flex;flex-wrap:wrap;gap:10px;}
    .chip{
      display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--border);
      border-radius:999px;background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .avatar{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;font-size:12px;font-weight:800;color:#fff;background:#64748b;flex:0 0 28px;}
    .role{color:var(--muted);font-size:12px;}
    .chip .rm{
      width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;color:inherit;
    }
    .add-row{margin-top:16px;}
    .add-staff{
      display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border:1px dashed var(--border);
      border-radius:12px;background:var(--card);cursor:pointer;font-weight:800;
    }

    .footer{
      padding:16px 22px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:10px;
      position:sticky;bottom:0;background:var(--card);
    }
    .btn{
      width:100%;height:48px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-weight:800;cursor:pointer;
      letter-spacing:.2px;transition:transform .12s ease, opacity .15s ease;
    }
    .btn:active{transform:scale(.996)}
    .btn[disabled]{opacity:.6;cursor:not-allowed;}
    .btn-ok{background:var(--ok);}
    .btn-secondary{background:#f3f4f6;border:1px solid var(--border);color:inherit;}

    .overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.42);backdrop-filter:blur(2px);
      padding:16px;z-index:50;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(520px,100%); background:var(--card); border:1px solid var(--border); border-radius:20px; overflow:hidden; box-shadow:0 28px 80px rgba(0,0,0,.28);
      display:flex;flex-direction:column;
    }
    .m-head{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid var(--border);}
    .m-head-title{font-size:18px;font-weight:800;}
    .m-close{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;color:inherit;}
    .m-body{padding:16px 18px;}
    .m-foot{padding:12px 18px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--border);}

    .inp{margin-bottom:12px;position:relative;}
    .inp input, .inp select{
      width:100%; height:50px; border-radius:12px; border:1px solid var(--border); background:var(--input);
      padding:0 14px 0 44px; font-size:14px; outline:none; transition:border-color .18s, box-shadow .18s, background .18s; color:inherit;
    }
    .inp input::placeholder{color:#9aa3af}
    .inp input:focus, .inp select:focus{border-color:#c7d2fe; background:#fff; box-shadow:0 0 0 4px var(--ring);}
    .inp i{position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#9aa0a6; font-size:14px; pointer-events:none;}
    .inp .err{display:none;color:var(--danger);font-size:12px;margin-top:6px;padding-left:2px;}
    .inp.invalid input, .inp.invalid select{border-color:var(--danger)}
    .inp.invalid .err{display:block}

    .phone-wrap{position:relative;}
    .phone-wrap .prefix{position:absolute; left:44px; top:50%; transform:translateY(-50%); font-weight:800; color:inherit;}
    .phone-wrap input{ padding-left: 80px; }

    .toast{
      position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
      background:#111;color:#fff;padding:8px 14px;border-radius:10px;font-size:14px;opacity:0;transition:.2s;z-index:60
    }
    .toast.show{opacity:1;}
  </style>
</head>
<body>
  <main class="container" role="main">
    <div class="top">
      <button class="back-btn" id="btnBack" aria-label="Geri"><i class="fa-solid fa-arrow-left"></i></button>
      <div class="progress-outer" aria-hidden="true"><div class="progress-inner"></div></div>
    </div>

    <div class="header">
      <h1>Daha Fazla Personel Eklemek İster misiniz?</h1>
      <p>Ekibinizin bilgilerini ekleyebilirsiniz.</p>
    </div>

    <section class="section" aria-labelledby="staffListTitle">
      <h2 id="staffListTitle" style="position:absolute;left:-9999px">Personel listesi</h2>
      <div class="staff-list" id="staffList">
        <div class="chip" id="ownerChip" aria-label="İşletme sahibi" style="display:none">
          <div class="avatar" id="ownerAvatar" aria-hidden="true">ME</div>
          <div>
            <div id="ownerName">Ben</div>
            <div class="role">Sahip</div>
          </div>
        </div>
      </div>
      <div class="add-row">
        <button class="add-staff" id="btnOpenModal" type="button" aria-haspopup="dialog">
          <i class="fa-solid fa-user-plus"></i> Personel ekle
        </button>
      </div>
    </section>

    <div class="footer">
      <button class="btn btn-ok" id="btnFinish">KAYDI TAMAMLA</button>
    </div>
  </main>

  <!-- Modal -->
  <div class="overlay" id="staffOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal">
      <div class="m-head">
        <div class="m-head-title" id="modalTitle">Personel Ekle</div>
        <button class="m-close" id="btnModalClose" aria-label="Kapat"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="m-body">
        <div class="inp" id="nameWrap">
          <i class="fa-solid fa-id-card"></i>
          <input type="text" id="name" placeholder="Ad Soyad" autocomplete="name" aria-label="Ad Soyad"/>
          <div class="err">Ad gerekli</div>
        </div>
        <div class="inp" id="phoneWrap">
          <i class="fa-solid fa-phone"></i>
          <div class="phone-wrap">
            <span class="prefix">+90</span>
            <input type="tel" id="phone" placeholder="5xx xxx xx xx" inputmode="numeric" autocomplete="tel" aria-label="Telefon"/>
          </div>
          <div class="err">Telefon 10 haneli olmalı</div>
        </div>
        <div class="inp" id="posWrap">
          <i class="fa-solid fa-briefcase"></i>
          <select id="position" aria-label="Pozisyon">
            <option value="" disabled selected>Pozisyon seçin</option>
            <option>Berber</option><option>Kuaför</option><option>Resepsiyonist</option>
          </select>
          <div class="err">Pozisyon seçin</div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn-secondary" id="btnCancel" type="button">İptal</button>
        <button class="btn" id="addBtn" type="button">Ekle</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">Eklendi</div>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import {
    createUserWithEmailAndPassword as createUser,
    fetchSignInMethodsForEmail as fetchMethods,
    signInWithEmailAndPassword as signIn,
    linkWithCredential as linkCred,
    EmailAuthProvider,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  /* ---------- Shortcuts ---------- */
  const $=s=>document.querySelector(s);
  const staffList=$("#staffList"), ownerChip=$("#ownerChip"), ownerAvatar=$("#ownerAvatar"), ownerNameEl=$("#ownerName");
  const overlay=$("#staffOverlay"), toast=$("#toast");
  const btnFinish=$("#btnFinish"); const btnOpen=$("#btnOpenModal"); const btnClose=$("#btnModalClose"); const btnCancel=$("#btnCancel"); const addBtn=$("#addBtn");

  const initials = n => n.split(" ").filter(Boolean).map(w=>w[0]).slice(0,2).join("").toUpperCase();
  const colors=['#111827','#2563eb','#0ea5e9','#059669','#f59e0b','#dc2626','#7c3aed'];
  const colorFor = n => colors[(n.codePointAt(0)||0)%colors.length];
  const showToast = m => { toast.textContent=m; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),1500); };

  const readStore = (k) => localStorage.getItem(k) ?? sessionStorage.getItem(k);
  const writeStore = (k,v) => { localStorage.setItem(k,v); };
  const removeStore = (k) => { localStorage.removeItem(k); sessionStorage.removeItem(k); };

  /* ---------- Flow guard ---------- */
  (function guard(){
    const flow=(readStore("admin_onboarding_flow")||"").toLowerCase();
    const email=(readStore("pending_admin_email")||"").trim();
    if(flow!=="admin" || !email){
      alert("Akış geçersiz. Lütfen kayıt sürecine baştan başlayın.");
      location.replace("admin-register-login.html");
      return;
    }
    if(!readStore("step7")) location.replace("admin-register7.html");
  })();

  /* ---------- Leave / Back ---------- */
  let allowLeave=false;
  $("#btnBack").addEventListener("click",(e)=>{ e.preventDefault(); persistStep8(); allowLeave=true; location.replace("admin-register7.html"); });
  window.addEventListener("beforeunload",(e)=>{ if(!allowLeave){ e.preventDefault(); e.returnValue=""; }});

  /* ---------- Owner chip ---------- */
  function renderOwner(){
    const prof = JSON.parse(readStore("pending_admin_profile")||"{}");
    const name = prof?.adminName || "Ben";
    ownerNameEl.textContent = name + " (Ben)";
    ownerAvatar.textContent = initials(name);
    ownerAvatar.style.background = colorFor(name);
    ownerChip.style.display="flex";
  }

  /* ---------- Working hours default from step6 ---------- */
  function getDefaultWorkingHours(){
    try{
      const raw = readStore("step6");
      const obj = raw ? JSON.parse(raw) : null;
      if(obj && obj.workingHours) return JSON.parse(JSON.stringify(obj.workingHours));
    }catch{}
    const base = (from="10:00",to="19:00") => ({open:true,from,to});
    return {
      "Pazartesi":base(),"Salı":base(),"Çarşamba":base(),"Perşembe":base(),"Cuma":base(),
      "Cumartesi":{open:false},"Pazar":{open:false}
    };
  }
  let SHOP_WORKING_HOURS = getDefaultWorkingHours();

  /* ---------- TR → ISO for businessHours ---------- */
  const TR2ISO = { "Pazartesi":"mon","Salı":"tue","Çarşamba":"wed","Perşembe":"thu","Cuma":"fri","Cumartesi":"sat","Pazar":"sun" };
  function toBusinessHoursISO(workingHoursTR){
    const out={};
    for(const [tr, v] of Object.entries(workingHoursTR || {})){
      const iso = TR2ISO[tr] || tr;
      out[iso] = v?.open ? { open: v.from, close: v.to, closed: false } : { open: null, close: null, closed: true };
    }
    return out;
  }

  /* ---------- Staff state ---------- */
  let members=[];
  function ensureWorkingHoursForAll(){
    members = (members||[]).map(m => {
      if(!m.workingHours) m.workingHours = JSON.parse(JSON.stringify(SHOP_WORKING_HOURS));
      return m;
    });
  }
  function persistStep8(){
    ensureWorkingHoursForAll();
    writeStore("step8", JSON.stringify({ staff: members }));
    writeStore("admin_onboarding_last_step","8");
  }
  function hydrateStep8(){
    try{
      const prev=JSON.parse(readStore("step8")||"null");
      if(prev?.staff) members=prev.staff;
      ensureWorkingHoursForAll();
    }catch{}
  }
  function renderMembers(){
    // temizle (owner hariç)
    [...staffList.querySelectorAll(".chip")].forEach(e=>{
      if(e.id!=="ownerChip") e.remove();
    });
    // ekle
    members.forEach((m,idx)=>{
      const el=document.createElement("div");
      el.className="chip";
      el.innerHTML=`
        <div class="avatar" style="background:${m.color}" aria-hidden="true">${m.initials}</div>
        <div>
          <div>${m.name}</div>
          <div class="role">${m.position||'Personel'} • ${m.phoneE164||('+90'+m.phone)}</div>
        </div>
        <button class="rm" aria-label="${m.name} kaydını kaldır" title="Kaldır">
          <i class="fa-solid fa-xmark"></i>
        </button>`;
      el.querySelector(".rm").addEventListener("click",()=>{
        members.splice(idx,1);
        renderMembers(); persistStep8(); showToast("Kaldırıldı");
      });
      // destek olarak dblclick
      el.title="Kaldırmak için tıklayın"; 
      el.ondblclick=()=>{ members.splice(idx,1); renderMembers(); persistStep8(); showToast("Kaldırıldı"); };
      staffList.appendChild(el);
    });
  }

  /* ---------- Modal behaviors ---------- */
  const phoneEl = $("#phone");
  const nameEl = $("#name");
  const posEl = $("#position");
  const nameWrap=$("#nameWrap"), phoneWrap=$("#phoneWrap"), posWrap=$("#posWrap");

  const maskTR = v => {
    const d=(v||"").replace(/\D/g,"").slice(0,10);
    let o=""; if(d.length>0) o+=d.slice(0,3);
    if(d.length>3) o+=" "+d.slice(3,6);
    if(d.length>6) o+=" "+d.slice(6,8);
    if(d.length>8) o+=" "+d.slice(8,10);
    return o;
  };
  phoneEl.addEventListener("input",e=> e.target.value = maskTR(e.target.value));

  function openModal(){
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    // focus trap
    const fEls = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const first=fEls[0], last=fEls[fEls.length-1];
    const trap=(e)=>{
      if(e.key!=="Tab") return;
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    };
    overlay.addEventListener("keydown",trap);
    overlay.dataset._trap="1";
    nameEl.focus({preventScroll:true});
  }
  function closeModal(){
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    // remove trap
    if(overlay.dataset._trap){ overlay.onkeydown=null; overlay.dataset._trap=""; }
    btnOpen.focus({preventScroll:true});
    clearErrors();
  }

  function clearErrors(){ [nameWrap,phoneWrap,posWrap].forEach(w=>w.classList.remove("invalid")); }

  btnOpen.onclick=openModal;
  btnClose.onclick=closeModal;
  btnCancel.onclick=closeModal;
  overlay.addEventListener("mousedown",(e)=>{ if(e.target===overlay) closeModal(); });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && overlay.classList.contains("show")) closeModal(); });

  function validateModal(){
    clearErrors();
    let ok=true;
    if(!nameEl.value.trim()){ nameWrap.classList.add("invalid"); ok=false; }
    const national = phoneEl.value.replace(/\D/g,"");
    if(!/^\d{10}$/.test(national)){ phoneWrap.classList.add("invalid"); ok=false; }
    if(!posEl.value){ posWrap.classList.add("invalid"); ok=false; }
    return { ok, national };
  }

  addBtn.onclick=()=>{
    const { ok, national } = validateModal();
    if(!ok) return;

    // duplicate check (by phone or same name+phone)
    const exists = members.some(m => m.phone === national || (m.name.trim().toLowerCase() === nameEl.value.trim().toLowerCase() && m.phone===national));
    if(exists){ showToast("Bu kişi zaten ekli"); return; }

    const name=nameEl.value.trim();
    const workingHoursCopy = JSON.parse(JSON.stringify(SHOP_WORKING_HOURS));
    const m={
      name,
      phone: national,                 // 10 hane
      phoneE164: `+90${national}`,     // +90 ile
      position: posEl.value || "Personel",
      initials: initials(name),
      color: colorFor(name),
      workingHours: workingHoursCopy
    };
    members.push(m); renderMembers(); closeModal();
    nameEl.value=""; phoneEl.value=""; posEl.selectedIndex=0;
    showToast("Personel eklendi");
    persistStep8();
  };

  // Enter ile ekleme
  [nameEl, phoneEl, posEl].forEach(el=>{
    el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addBtn.click(); }});
  });

  /* ---------- Auth helpers + finalize ---------- */
  async function ensureSignedIn(email, password) {
    if (!auth.currentUser) {
      const cred = await signIn(email, password);
      await cred.user.getIdToken(true);
      return cred.user;
    }
    await auth.currentUser.getIdToken(true);
    return auth.currentUser;
  }

  function buildPayload(){
    const prof = JSON.parse(readStore("pending_admin_profile")||"{}"); // {businessTypes,businessName,adminName,adminPhone}
    const step3 = JSON.parse(readStore("step3")||"null");              // {hasMobileService}
    const step4 = JSON.parse(readStore("step4")||"null");              // {travel:{...}}
    const step5 = JSON.parse(readStore("step5")||"null");              // {businessLocation:{...}}
    const step6 = JSON.parse(readStore("step6")||"null");              // {workingHours:{...}}
    const step7 = JSON.parse(readStore("step7")||"null");              // {services:[...]}

    const ownerEmail = (readStore("pending_admin_email")||"").trim().toLowerCase();
    const ownerPhoneNational = prof?.adminPhone ? String(prof.adminPhone) : ""; // 10 hane
    const ownerPhoneE164 = ownerPhoneNational ? `+90${ownerPhoneNational}` : "";

    const business = {
      name: prof?.businessName || "",
      types: Array.isArray(prof?.businessTypes) ? prof.businessTypes : []
    };

    const owner = { name: prof?.adminName || "", email: ownerEmail, phoneNational: ownerPhoneNational || null, phoneE164: ownerPhoneE164 || null };
    const travel = step4?.travel || null;
    const businessLocation = step5?.businessLocation || null;
    const workingHours = step6?.workingHours || getDefaultWorkingHours();
    const services = Array.isArray(step7?.services) ? step7.services : [];

    return {
      owner, business,
      hasMobileService: !!(step3?.hasMobileService),
      travel, businessLocation,
      workingHours, services,
      staff: members || [],
      onboardingCompleted:true,
      updatedAt:serverTimestamp()
    };
  }

  btnFinish.onclick = async () => {
    try{
      persistStep8();
      const email=(readStore("pending_admin_email")||"").trim().toLowerCase();
      const password=(readStore("pending_admin_password")||"");
      if(!email||!password){ alert("E-posta/şifre eksik."); return; }

      btnFinish.disabled=true; const old=btnFinish.textContent; btnFinish.textContent="Kaydediliyor…";

      let methods=[];
      try{ methods=await fetchMethods(auth,email); }catch{ methods=[]; }

      let uid=null;
      if(methods.length===0){ uid=(await createUser(auth,email,password)).user.uid; }
      else if(methods.includes("password")){ uid=(await signIn(auth,email,password)).user.uid; }
      else if(auth.currentUser && auth.currentUser.isAnonymous){ uid=(await linkCred(auth.currentUser, EmailAuthProvider.credential(email,password))).user.uid; }
      else{ alert("Bu e-posta farklı yöntemle kayıtlı (ör. Google). Lütfen giriş sayfasından deneyin."); btnFinish.disabled=false; btnFinish.textContent=old; return; }

      await ensureSignedIn(email,password);

      const payload = buildPayload();

      const retro = { email, step:8, progress:{completed:[1,2,3,4,5,6,7,8],current:8,total:9} };

      // 1) Onboarding snapshot
      await setDoc(doc(db,"adminOnboarding",uid),{...payload, ...retro, role:"owner", ownerId:uid},{merge:true});

      // 2) Role
      await setDoc(doc(db,"roles",uid),{role:"admin",createdAt:serverTimestamp()},{merge:true});

      // 3) Email index
      await setDoc(
        doc(db,"email_index",encodeURIComponent(email)),
        {
          email, roleHint:"admin", reserved:true, flow:"admin",
          ownerName: payload.owner?.name || "",
          businessName: payload.business?.name || "",
          updatedAt:serverTimestamp()
        },
        {merge:true}
      );

      // 4) Business
      const bhISO = toBusinessHoursISO(payload.workingHours || {});
      const servicesForBiz = (payload.services || []).map((name) => ({ name, min: 30, price: "" }));

      await setDoc(
        doc(db, "businesses", uid),
        {
          name: payload.business?.name || "",
          types: Array.isArray(payload.business?.types) ? payload.business.types : [],
          email: payload.owner?.email || "",
          phone: payload.owner?.phoneNational || "",
          businessHours: bhISO,
          workingHours: payload.workingHours || {},
          businessLocation: payload.businessLocation || null,
          hasMobileService: !!payload.hasMobileService,
          travel: payload.travel || null,
          services: servicesForBiz,
          staff: payload.staff || [],
          images: { cover: [], model: [], salon: [] },
          owner: {
            name: payload.owner?.name || "",
            email: payload.owner?.email || "",
            phoneE164: payload.owner?.phoneE164 || null,
            phoneNational: payload.owner?.phoneNational || null,
            ownerId: uid
          },
          role: "owner",
          progress: { completed:[1,2,3,4,5,6,7,8], current:8, total:9 },
          onboardingCompleted: true,
          updatedAt: serverTimestamp()
        },
        { merge: true }
      );

      writeStore("__reg_ok","1");
      writeStore("admin_onboarding_last_step","8");
      removeStore("pending_admin_password");

      try{ await signOut(auth);}catch{}
      alert("Kayıt tamamlandı! Şimdi giriş yapabilirsiniz.");
      allowLeave=true; location.replace("admin-register-login.html#login");
    }catch(err){
      console.error(err);
      alert("İşlem başarısız: "+(err?.message||String(err)));
      btnFinish.disabled=false; btnFinish.textContent="KAYDI TAMAMLA";
    }
  };

  /* ---------- Init ---------- */
  (function init(){
    renderOwner();
    hydrateStep8();
    renderMembers();
  })();
</script>
</body>
</html>
